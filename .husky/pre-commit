#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# Function to check for API keys
check_api_keys() {
    # Datadog API key patterns
    DD_API_KEY_PATTERN='[a-f0-9]{32}'
    DD_APP_KEY_PATTERN='[a-f0-9]{40}'
    
    # Get list of staged files
    FILES=$(git diff --cached --name-only)
    
    # Check each staged file
    for FILE in $FILES; do
        # Skip binary files
        if [[ -f "$FILE" ]] && [[ -n $(git diff --cached --name-only "$FILE") ]]; then
            # Check for Datadog API keys
            if git diff --cached "$FILE" | grep -E "$DD_API_KEY_PATTERN" > /dev/null; then
                echo "Error: Potential Datadog API key found in $FILE"
                echo "Please remove the API key and use environment variables instead."
                exit 1
            fi
            
            if git diff --cached "$FILE" | grep -E "$DD_APP_KEY_PATTERN" > /dev/null; then
                echo "Error: Potential Datadog APP key found in $FILE"
                echo "Please remove the APP key and use environment variables instead."
                exit 1
            fi
        fi
    done
}

# Run the check
check_api_keys

# If you need to bypass this check in special cases, use:
# git commit --no-verify

---
/**
 * Dynamic Episode Page
 * 
 * This component dynamically loads episode content from the imported HTML files
 * while maintaining consistent headers and footers through MainLayout.
 * 
 * Uses environment-aware URL paths to ensure consistency across environments.
 */
import MainLayout from '../../layouts/MainLayout.astro';
import fs from 'node:fs';
import path from 'node:path';

// Get URL prefix from environment variables - same logic as in Header.astro
let pathPrefix = import.meta.env.URL_PREFIX || process.env.URL_PREFIX || '';

// Fallback detection based on hostname
if (pathPrefix === '') {
  if (Astro.url.hostname === 'ai-tools-lab.com') {
    // Production environment needs /pages prefix
    pathPrefix = '/pages';
  } else {
    // Test environment uses direct routes
    pathPrefix = '';
  }
}

// Get all episode files that exist in our content directory
export function getStaticPaths() {
  // Explicitly define all 20 episodes to ensure consistency
  const episodes = Array.from({ length: 20 }, (_, i) => {
    const num = i + 1;
    const paddedNum = num.toString().padStart(2, '0');
    return {
      params: { episode: `ep${paddedNum}` }
    };
  });
    
  return episodes;
}

// Load the episode content
const { episode } = Astro.params;
let contentHtml = '';

try {
  // Import episode content directly using Astro's ?raw import
  const importedContent = await import(`../../content/imported/episodes/${episode}.html?raw`);
  contentHtml = importedContent.default;
} catch (e) {
  // Fallback content if episode not found
  contentHtml = `<div class="episode-content"><h1>Episode ${episode}</h1><p>Content coming soon.</p></div>`;
}

// Determine episode number for title
const episodeNum = episode.replace('ep', '');
const title = `Episode ${episodeNum} | AI Tools Lab`;
---

<MainLayout title={title}>
  <div class="episode-container">
    <!-- Dynamically insert the episode content without headers/footers -->
    <div set:html={contentHtml} />
    
    <!-- Episode navigation -->
    <div class="episode-navigation">
      <div class="episode-nav-links">
        <a href="${pathPrefix}/episodes" class="episode-back">‚Üê Back to Episodes</a>
      </div>
    </div>
  </div>
</MainLayout>

<style>
  .episode-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 1rem;
  }
  
  .episode-navigation {
    margin-top: 3rem;
    padding-top: 1rem;
    border-top: 1px solid #eaeaea;
  }
  
  .episode-nav-links {
    display: flex;
    justify-content: space-between;
  }
  
  .episode-back {
    display: inline-block;
    margin-right: auto;
    color: #0070f3;
    text-decoration: none;
  }
  
  .episode-back:hover {
    text-decoration: underline;
  }
</style>

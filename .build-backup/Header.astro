---
// Header component adapted to match live site structure with environment detection

// IMPORTANT: Link verification and environment-aware URL generation
// This ensures all links work properly in both environments:
// - Production (ai-tools-lab.com): URL_PREFIX = '/pages'
// - Test (ai-tools-lab-tst.netlify.app): URL_PREFIX = ''

// STANDARDIZED APPROACH: Make test environment match production exactly
// Always use /pages prefix for all environments to ensure consistency
// This matches the change in [episode].astro and fixes the URL structure mismatch
let pathPrefix = '/pages';

// No conditional environment detection - standardizing on one pattern for simplicity
// This reduces configuration complexity and follows the 'less configuration is better' principle


// Create environment-aware paths for navigation
const homePath = `${pathPrefix}/`;
const resourcesPath = `${pathPrefix}/resources`;
const observationsPath = `${pathPrefix}/observations`;
const aboutPath = `${pathPrefix}/about`;
---
<!-- Header with site-header class for Datadog test detection -->
<header class="site-header">
  <!-- Bubble elements from live site -->
  <div class="bubble"></div>
  <div class="bubble"></div>
  <div class="bubble"></div>
  <div class="bubble"></div>
  <div class="bubble"></div>
  <div class="bubble"></div>
  <div class="bubble"></div>

  <div class="container header-content-container"> {/* Renamed class to avoid conflict */} 
    <div class="logo">
      <!-- Structure matching live site -->
      <a href={homePath} class="logo-link" aria-label="AI Tools Lab Home">
        <img src="/images/ai-tools-lab-logo.png" alt="AI Tools Lab Logo" class="site-logo" width="48" height="48">
        <span>AI Tools Lab</span>
      </a>
    </div>
    
    <!-- Desktop Navigation -->
    <nav class="main-nav" role="navigation" aria-label="Main navigation">
      <ul>
        <li><a href={homePath} class:list={{ active: Astro.url.pathname === homePath }}>Home</a></li>
        <li><a href={resourcesPath} class:list={{ active: Astro.url.pathname === resourcesPath || Astro.url.pathname.startsWith(`${resourcesPath}/`) }}>Resources</a></li>
        <li><a href={observationsPath} class:list={{ active: Astro.url.pathname === observationsPath || Astro.url.pathname.startsWith(`${observationsPath}/`) }}>Observations</a></li>
        <li><a href={aboutPath} class:list={{ active: Astro.url.pathname === aboutPath }}>About</a></li>
      </ul>
    </nav>

    <!-- Mobile Menu Toggle (using structure from live site) -->
    <div class="hamburger-menu" role="button" tabindex="0" aria-label="Toggle navigation menu">
      <img src="/images/ai-tools-lab-logo.webp" width="24" height="24" alt="Menu">
    </div>

    <!-- Mobile Navigation (adapting structure from previous local version) --> 
    <nav class="mobile-nav" role="navigation" aria-label="Mobile navigation">
      <ul>
        <li><a href={homePath}>Home</a></li>
        <li><a href={resourcesPath}>Resources</a></li>
        <li><a href={observationsPath}>Observations</a></li>
        <li><a href={aboutPath}>About</a></li>
      </ul>
    </nav>

  </div>
</header>

<style>
  /* Simplified styles for the Astro component scope */
  /* Basic layout and desktop/mobile visibility */
  .site-header {
    position: relative; /* Needed for bubble absolute positioning */
    background-color: var(--secondary-color, #93ACB5); /* Ensure consistent background color matching production */
    color: white;
    padding: 1.5rem 0 0 0;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 0;
    overflow: visible;
    border-bottom: none;
    z-index: 2;
  }

  .header-content-container { /* Updated class name */
    display: flex;
    justify-content: space-between;
    align-items: center;
    /* Padding etc. from global styles.css */
    position: relative; /* Ensure content is above bubbles */
    z-index: 2;
  }

  /* Logo styles matching live site classes */
  .logo {
    display: flex;
    align-items: center;
  }
  .logo .site-logo {
    /* Dimensions should come from global */
    margin-right: 1rem;
    vertical-align: middle;
  }
  .logo a {
    /* Styling from global */
    text-decoration: none; /* Ensure no underline */
    font-size: 3rem; /* Match live site inline style */
  }

  /* Desktop Nav visibility */
  .main-nav {
    display: none; /* Hidden by default */
  }
  .main-nav ul {
    display: flex;
    list-style: none;
    padding: 0;
    margin: 0;
    gap: 1.5rem; /* Adjust gap as needed, matching live site visually */
  }
  .main-nav a {
    /* Styling from global */
    text-decoration: none;
  }
  .main-nav a.active {
    /* Active state styling from global */
    font-weight: bold; /* Example, adjust in global */
  }

  /* Mobile Menu Toggle visibility */
  .hamburger-menu {
    display: block; /* Visible by default */
    cursor: pointer;
    /* Needs width/height/styling from global */
  }
  .hamburger-menu img {
    display: block; /* Prevent extra space below image */
  }

  /* Mobile Nav styles */
  .mobile-nav {
    display: none; /* Hidden by default */
    position: fixed; 
    top: 0;
    right: 0;
    width: 250px; 
    height: 100%;
    background-color: var(--primary-color, #6C756B); 
    padding: 20px; 
    box-shadow: -2px 0 5px rgba(0,0,0,0.2);
    z-index: 1000;
  }
  .mobile-nav ul {
    list-style: none;
    padding: 40px 0 0 0; /* Add padding to clear header */
    margin: 0;
  }
  .mobile-nav li {
    margin-bottom: 15px;
  }
  .mobile-nav a {
    text-decoration: none;
    color: white;
    font-size: 1.2em;
    display: block; 
    padding: 10px;
    border-radius: 5px;
    transition: background-color 0.2s ease;
  }
   .mobile-nav a:hover {
     background-color: rgba(255, 255, 255, 0.1);
   }

   /* Show mobile nav when header has .is-open class */ 
   .site-header.is-open .mobile-nav {
     display: block !important; 
   }

   /* --- Desktop Styles --- */
   @media (min-width: 769px) { 
     .main-nav {
       display: block; /* Show main nav on desktop */
     }
     .hamburger-menu,
     .mobile-nav {  
       display: none; /* Hide mobile elements on desktop */
     }
   }

  /* Bubble styles should be defined in global styles.css */
  .bubble {
    /* Placeholder - Define in global styles.css */
    /* Example: position: absolute; background: white; border-radius: 50%; */ 
  }

</style>

<script define:vars={{pathPrefix}}>
  // Client-side code - only runs in the browser
  console.log("Build mode"); /* console.log("Build mode"); /* console.log("Build mode"); /* document.addEventListener('DOMContentLoaded', () => {
    // Mobile menu functionality
    const header = /* document.querySelector('.site-header');
    const toggleButton = /* document.querySelector('.hamburger-menu');
    const mobileNav = /* document.querySelector('.mobile-nav');
    const mobileNavLinks = mobileNav ? mobileNav.querySelectorAll('a') : [];

    if (!header || !toggleButton || !mobileNav) {
      console.error('Header toggle elements not found!');
      return;
    }

    // Ensure links use correct environment path structure
    // This fixes the issue where test environment has /pages/ links
    const fixEnvironmentLinks = () => {
      // Get all links in the document
      const allLinks = /* document.querySelectorAll('a[href]');
      const hostname = window.location.hostname;
      const isProduction = hostname === 'ai-tools-lab.com';

      allLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (!href) return;
        
        // Fix links on test environment that have /pages/ prefix
        if (!isProduction && href.startsWith('/pages/')) {
          // Convert /pages/something to /something
          const fixedHref = href.replace('/pages/', '/');
          link.setAttribute('href', fixedHref);
        }
        
        // Fix links on production environment that don't have /pages/ prefix
        if (isProduction && !href.startsWith('/pages/') && !href.startsWith('http') && !href.startsWith('#')) {
          // Make sure we don't double-prefix
          if (href === '/') {
            link.setAttribute('href', '/pages/');
          } else if (!href.startsWith('/pages/')) {
            const fixedHref = `/pages${href}`;
            link.setAttribute('href', fixedHref);
          }
        }
      });
    };

    // Fix environment links on page load
    fixEnvironmentLinks();

    // Standard mobile menu functionality
    const toggleMenu = () => {
      header.classList.toggle('is-open');
    };

    const closeMenu = () => {
      header.classList.remove('is-open');
    };

    toggleButton.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleMenu();
    });

    mobileNavLinks.forEach(link => {
      link.addEventListener('click', closeMenu);
    });
  });
</script>

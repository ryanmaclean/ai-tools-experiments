name: Deploy to Netlify

# This workflow handles deployment to Netlify from the test branch
# For GitHub Pages deployment, see the deploy.yml workflow

on:
  push:
    branches:
      - test
    paths-ignore:
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'netlify'
        type: choice
        options:
          - netlify

# Environment variables will be set directly in the GitHub repository settings

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      
      - name: Set up Node.js
        uses: actions/setup-node@60edb5dd545a775178f52524783378180af0d1f8 # v4.0.2
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Configure Datadog Test Optimization
        id: datadog-test-visibility
        uses: datadog/test-visibility-github-action@f9c37a3e981cfcd76b29a38bc1071d36485be55f # v2.0.4
        with:
          languages: js
          api_key: ${{ secrets.DD_API_KEY }}
          site: datadoghq.com
      
      - name: Run tests
        shell: bash
        run: npm run test:resources
        env:
          NODE_OPTIONS: -r ${{ steps.datadog-test-visibility.outputs.dd-trace-package }} --import ${{ steps.datadog-test-visibility.outputs.dd-trace-esm-import }}
      
      - name: Inject Datadog API Keys
        run: |
          # Check if secrets are available (will be masked in logs)
          if [[ -n "$DD_API_KEY" ]]; then
            echo "DD_API_KEY is available"
          else
            echo "WARNING: DD_API_KEY is not set in repository secrets!"
          fi
          
          if [[ -n "$DD_APP_KEY" ]]; then
            echo "DD_APP_KEY is available"
          else
            echo "WARNING: DD_APP_KEY is not set in repository secrets!"
          fi
          
          # Replace placeholder values with secrets in script.js
          sed -i "s|__DD_API_KEY__|$DD_API_KEY|g" script.js
          sed -i "s|__DD_APP_KEY__|$DD_APP_KEY|g" script.js
        env:
          DD_API_KEY: ${{ secrets.DD_API_KEY }}
          DD_APP_KEY: ${{ secrets.DD_APP_KEY }}
      
      - name: Build Astro site
        run: npm run build
      
      - name: Deploy to Netlify
        uses: nwtgck/actions-netlify@776676e806d17d7d129ef03acb5f71f2e38b1ed5 # v2.1.0
        with:
          publish-dir: './dist'
          production-branch: test
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Deploy from GitHub Actions"
          enable-pull-request-comment: true
          enable-commit-comment: true
          overwrites-pull-request-comment: true
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        timeout-minutes: 5
      
      - name: Trigger Netlify Build Hook (Fallback)
        if: failure()
        run: |
          curl -X POST -d {} https://api.netlify.com/build_hooks/6815aa2896ae6ddba51a8a30
          echo "Triggered Netlify build hook as fallback"
